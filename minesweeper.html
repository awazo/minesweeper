<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<style type="text/css">
* { padding: 0px; margin: 0px; }
dt, dd { display: inline; }
dt:after { content: ":"; }
</style>
<title>minesweeper</title>
</head>
<body>
<div id="message">
under constructions...
<br />
to mark as FLAG (it'll not be open by click), long-click a tile.<br />
long-click is mouse-down then wait a second.<br />
if un-mark FLAG, long-click again.
</div>

<table id="gameBoard">
<!--
<tbody id="gameBoardBody">
</tbody>
-->
</table>

<script>
//<![CDATA[
function getTd(tbodyObj, row, col) {
  if((tbodyObj === undefined) || (tbodyObj === null)) return null;
  var trList = tbodyObj.getElementsByTagName("TR");
  if((trList === null) || (trList.length <= row)) return null;
  var tdList = trList[row].getElementsByTagName("TD");
  if((tdList === null) || (tdList.length <= col)) return null;
  return tdList[col];
}
function getTbodySize(tbodyObj) {
  var trList = tbodyObj.getElementsByTagName("TR");
  var tdList = trList[0].getElementsByTagName("TD");
  return [trList.length, tdList.length];
}
function forEachTd(tbodyObj, funcApplyToTd) {
  var tbodySize = getTbodySize(tbodyObj);
  for(var i = 0; i < tbodySize[0]; i++)
    for(var j = 0; j < tbodySize[1]; j++)
      funcApplyToTd(getTd(tbodyObj, i, j), i, j);
}
//]]>
</script>

<script>
//<![CDATA[
var ROW_INDEX_ATTR_NAME = "dataRowindex";
var COL_INDEX_ATTR_NAME = "dataColindex";

function createTbody(row, col) {
  var tbodyObj = document.createElement("TBODY");
  if(row <= 0) return tbodyObj;
  for(var i = 0; i < row; i++) {
    var trObj = document.createElement("TR");
    trObj.setAttribute(ROW_INDEX_ATTR_NAME, i);
    for(var j = 0; j < col; j++) {
      var tdObj = document.createElement("TD");
      tdObj.setAttribute(COL_INDEX_ATTR_NAME, j);
      trObj.appendChild(tdObj);
    }
    tbodyObj.appendChild(trObj);
  }
  return tbodyObj;
}
function getTdIndex(tdObj) {
  return [tdObj.parentNode.getAttribute(ROW_INDEX_ATTR_NAME),
    tdObj.getAttribute(COL_INDEX_ATTR_NAME)];
}

var GAME_BOARD_BODY_ID = "gameBoardBody";

function getInitializedGameBoard(row, col, mines) {
  var tbodyObj = createTbody(row, col);
  tbodyObj.id = GAME_BOARD_BODY_ID;
  forEachTd(tbodyObj, function(tdObj, r, c) {
      var tile = getTileCopy("tileNormal");
      tdObj.appendChild(tile);
      //TODO: implement
    });
  return tbodyObj;
}
//]]>
</script>

<script>
//<![CDATA[
function StatedTimeout() {
  this.state = 0;
  // 0: none, 1: started, 2: canceled, 3: completed
  this.stateName = ["none", "started", "canceled", "completed"];
  this.timerId = null;
  this.setTimeout = function(f, ms) {
    if(this.state === 1) return;
    this.state = 1;
    var outerObj = this;
    this.timerId = setTimeout(function() { outerObj.state = 3; f(); }, ms);
  };
  this.clearTimeout = function() {
    if((this.timerId !== null) || (this.timerId !== undefined))
      clearTimeout(this.timerId);
    if(this.state === 1) this.state = 2;
    else this.state = 0;
  };
}
//]]>
</script>

<script>
//<![CDATA[
function getTileCopy(tileId) {
  var target = document.getElementById(tileId);
  if(target === null) return null;
  var ret = target.cloneNode(true);
  ret.id = "";
  return ret;
}
function tileToFlag(tdObj) {
  tdObj.removeChild(tdObj.children[0]);
  tdObj.appendChild(getTileCopy("tileFlag"));
}
function tileToNormal(tdObj) {
  tdObj.removeChild(tdObj.children[0]);
  tdObj.appendChild(getTileCopy("tileNormal"));
}
function tileToMine(tdObj) {
  tdObj.removeChild(tdObj.children[0]);
  tdObj.appendChild(getTileCopy("tileMine"));
}
function tileToOpen(tdObj, tileType) {
  tdObj.removeChild(tdObj.children[0]);
  var tileId = "tileOpen".concat(tileType);
  var tile = getTileCopy(tileId);
  if(tile === null) tile = getTileCopy("tileMine");
  tdObj.appendChild(tile);
}

var tileLongClick;
var LONG_CLICK_TIMEOUT_MS = 1000;

function onNormalMouseDown(targetObj) {
  var tdObj = targetObj;
  while(tdObj.nodeName !== "TD") tdObj = tdObj.parentNode;
  if((tileLongClick === undefined) || (tileLongClick === null))
    tileLongClick = new StatedTimeout();
  tileLongClick.setTimeout(function() {
    tileToFlag(tdObj);
  }, LONG_CLICK_TIMEOUT_MS);
}
function onNormalMouseUp(targetObj) {
  var tdObj = targetObj;
  while(tdObj.nodeName !== "TD") tdObj = tdObj.parentNode;
  if(tileLongClick.state === 1) {
    tileToOpen(tdObj, tdObj.getAttribute("dataMines"));
    tileLongClick.clearTimeout();
  }
}
function onFlagMouseDown(targetObj) {
  var tdObj = targetObj;
  while(tdObj.nodeName !== "TD") tdObj = tdObj.parentNode;
  if((tileLongClick === undefined) || (tileLongClick === null))
    tileLongClick = new StatedTimeout();
  tileLongClick.setTimeout(function() {
    tileToNormal(tdObj);
  }, LONG_CLICK_TIMEOUT_MS);
}
function onFlagMouseUp(targetObj) {
  var tdObj = targetObj;
  while(tdObj.nodeName !== "TD") tdObj = tdObj.parentNode;
  if(tileLongClick.state === 1) tileLongClick.clearTimeout();
}
//]]>
</script>

<dl>
<dt>
<svg id="tileNormal" width="20" height="20"
  onmousedown="onNormalMouseDown(this)" onmouseup="onNormalMouseUp(this)">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 18,18 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
</svg>
</dt>
<dd>This tile will be opend by click, or mark flag by long-click.</dd>
<br />
<dt>
<svg id="tileFlag" width="20" height="20"
  onmousedown="onFlagMouseDown(this)" onmouseup="onFlagMouseUp(this)">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 18,18 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <path d="M 3 2 q 3 4 5 2 q 3 -4 6 0 l 0 6 q -3 -4 -5 0 q -3 2 -6 -4"
    style="fill:red;stroke:red;stroke-width:1;" />
  <rect x="3" y="2" width="2" height="13"
    style="fill:rgb(153,102,0);stroke:none;" />
</svg>
</dt>
<dd>This tile is marked by flag. To un-mark, long-click it. </dd>
<br />
<dt>
<svg id="tileOpen0" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
</svg>
<span style="display: none">
<svg id="tileOpen1" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">1</text>
</svg>
<svg id="tileOpen2" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">2</text>
</svg>
<svg id="tileOpen3" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">3</text>
</svg>
<svg id="tileOpen4" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">4</text>
</svg>
<svg id="tileOpen5" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">5</text>
</svg>
<svg id="tileOpen6" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">6</text>
</svg>
<svg id="tileOpen7" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:black;stroke:black;stroke-width:1;">7</text>
</svg>
<svg id="tileOpen8" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <text x="5" y="16"
    style="fill:darkorange;stroke:darkorange;stroke-width:1;">8</text>
</svg>
</span>
</dt>
<dd>This tile is opend. If it has number, the number of mines are around. </dd>
<br />
<dt>
<svg id="tileMine" width="20" height="20">
  <rect width="20" height="20"
    style="fill:rgb(216,216,216);stroke:rgb(128,128,128);stroke-width:0;" />
  <polyline points="18,0 0,0 0,18"
    style="fill:none;stroke:rgb(128,128,128);stroke-width:4" />
  <polyline points="5,5 9,9 5,13"
    style="fill:none;stroke:red;stroke-width:2;" />
  <polyline points="17,5 13,9 17,13"
    style="fill:none;stroke:red;stroke-width:2;" />
  <line x1="8" y1="15" x2="14" y2="15"
    style="fill:none;stroke:red;stroke-wdith:2;" />
</svg>
</dt>
<dd>This is mine tile. If you opened tile and appear this tile, game is over and you lose. </dd>
</dl>

<script>
//<![CDATA[
try{
var boardBody = getInitializedGameBoard(5, 5, 0);
document.getElementById("gameBoard").appendChild(boardBody);
/*
var boardBody = document.getElementById("gameBoardBody");
var tr = document.createElement("TR");
boardBody.appendChild(tr);
var td = document.createElement("TD");
tr.appendChild(td);
var t = document.getElementById("tileNormal").cloneNode(true);
t.id = "";
td.appendChild(t);
td.setAttribute("dataMines", "1");
*/
}catch(e){console.log(e);}
//]]>
</script>

</body>
</html>

